!function(){"use strict";function e(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=Array(t);n<t;n++)r[n]=e[n];return r}function t(e,t,n,r,o,a,i){try{var s=e[a](i),c=s.value}catch(e){return void n(e)}s.done?t(c):Promise.resolve(c).then(r,o)}function n(e){return function(){var n=this,r=arguments;return new Promise((function(o,a){var i=e.apply(n,r);function s(e){t(i,o,a,s,c,"next",e)}function c(e){t(i,o,a,s,c,"throw",e)}s(void 0)}))}}function r(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function o(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,l(r.key),r)}}function a(e,t,n){return t&&o(e.prototype,t),n&&o(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function i(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=f(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,o=function(){};return{s:o,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,i=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return i=e.done,e},e:function(e){s=!0,a=e},f:function(){try{i||null==n.return||n.return()}finally{if(s)throw a}}}}function s(){s=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},i=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",u=a.toStringTag||"@@toStringTag";function l(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{l({},"")}catch(e){l=function(e,t,n){return e[t]=n}}function d(e,t,n,r){var a=t&&t.prototype instanceof v?t:v,i=Object.create(a.prototype),s=new A(r||[]);return o(i,"_invoke",{value:N(e,n,s)}),i}function f(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=d;var p="suspendedStart",h="suspendedYield",m="executing",w="completed",g={};function v(){}function y(){}function D(){}var S={};l(S,i,(function(){return this}));var k=Object.getPrototypeOf,T=k&&k(k(P([])));T&&T!==n&&r.call(T,i)&&(S=T);var b=D.prototype=v.prototype=Object.create(S);function E(e){["next","throw","return"].forEach((function(t){l(e,t,(function(e){return this._invoke(t,e)}))}))}function I(e,t){function n(o,a,i,s){var c=f(e[o],e,a);if("throw"!==c.type){var u=c.arg,l=u.value;return l&&"object"==typeof l&&r.call(l,"__await")?t.resolve(l.__await).then((function(e){n("next",e,i,s)}),(function(e){n("throw",e,i,s)})):t.resolve(l).then((function(e){u.value=e,i(u)}),(function(e){return n("throw",e,i,s)}))}s(c.arg)}var a;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,o){n(e,r,t,o)}))}return a=a?a.then(o,o):o()}})}function N(t,n,r){var o=p;return function(a,i){if(o===m)throw Error("Generator is already running");if(o===w){if("throw"===a)throw i;return{value:e,done:!0}}for(r.method=a,r.arg=i;;){var s=r.delegate;if(s){var c=R(s,r);if(c){if(c===g)continue;return c}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(o===p)throw o=w,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);o=m;var u=f(t,n,r);if("normal"===u.type){if(o=r.done?w:h,u.arg===g)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(o=w,r.method="throw",r.arg=u.arg)}}}function R(t,n){var r=n.method,o=t.iterator[r];if(o===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,R(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),g;var a=f(o,t.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,g;var i=a.arg;return i?i.done?(n[t.resultName]=i.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,g):i:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,g)}function C(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function x(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function A(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(C,this),this.reset(!0)}function P(t){if(t||""===t){var n=t[i];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var o=-1,a=function n(){for(;++o<t.length;)if(r.call(t,o))return n.value=t[o],n.done=!1,n;return n.value=e,n.done=!0,n};return a.next=a}}throw new TypeError(typeof t+" is not iterable")}return y.prototype=D,o(b,"constructor",{value:D,configurable:!0}),o(D,"constructor",{value:y,configurable:!0}),y.displayName=l(D,u,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,D):(e.__proto__=D,l(e,u,"GeneratorFunction")),e.prototype=Object.create(b),e},t.awrap=function(e){return{__await:e}},E(I.prototype),l(I.prototype,c,(function(){return this})),t.AsyncIterator=I,t.async=function(e,n,r,o,a){void 0===a&&(a=Promise);var i=new I(d(e,n,r,o),a);return t.isGeneratorFunction(n)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},E(b),l(b,u,"Generator"),l(b,i,(function(){return this})),l(b,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=P,A.prototype={constructor:A,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(x),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function o(r,o){return s.type="throw",s.arg=t,n.next=r,o&&(n.method="next",n.arg=e),!!o}for(var a=this.tryEntries.length-1;a>=0;--a){var i=this.tryEntries[a],s=i.completion;if("root"===i.tryLoc)return o("end");if(i.tryLoc<=this.prev){var c=r.call(i,"catchLoc"),u=r.call(i,"finallyLoc");if(c&&u){if(this.prev<i.catchLoc)return o(i.catchLoc,!0);if(this.prev<i.finallyLoc)return o(i.finallyLoc)}else if(c){if(this.prev<i.catchLoc)return o(i.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<i.finallyLoc)return o(i.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n];if(o.tryLoc<=this.prev&&r.call(o,"finallyLoc")&&this.prev<o.finallyLoc){var a=o;break}}a&&("break"===e||"continue"===e)&&a.tryLoc<=t&&t<=a.finallyLoc&&(a=null);var i=a?a.completion:{};return i.type=e,i.arg=t,a?(this.method="next",this.next=a.finallyLoc,g):this.complete(i)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),x(n),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var o=r.arg;x(n)}return o}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:P(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),g}},t}function c(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,o,a,i,s=[],c=!0,u=!1;try{if(a=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;c=!1}else for(;!(c=(r=a.call(n)).done)&&(s.push(r.value),s.length!==t);c=!0);}catch(e){u=!0,o=e}finally{try{if(!c&&null!=n.return&&(i=n.return(),Object(i)!==i))return}finally{if(u)throw o}}return s}}(e,t)||f(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(t)||f(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function l(e){var t=function(e,t){if("object"!=typeof e||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:t+""}function d(e){return d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},d(e)}function f(t,n){if(t){if("string"==typeof t)return e(t,n);var r={}.toString.call(t).slice(8,-1);return"Object"===r&&t.constructor&&(r=t.constructor.name),"Map"===r||"Set"===r?Array.from(t):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?e(t,n):void 0}}String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,"")}),"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return this.slice(-e.length)==e});var p={exports:{}};
/*! streamsaver. MIT License. Jimmy Wärting <https://jimmy.warting.se/opensource> */!function(e){var t;t=()=>{const e="object"==typeof window?window:this;e.HTMLElement||console.warn("streamsaver is meant to run on browsers main thread");let t=null,n=!1;const r=e.WebStreamsPolyfill||{},o=e.isSecureContext;let a=/constructor/i.test(e.HTMLElement)||!!e.safari||!!e.WebKitPoint;const i=o||"MozAppearance"in document.documentElement.style?"iframe":"navigate",s={createWriteStream:function(r,u,l){let d={size:null,pathname:null,writableStrategy:void 0,readableStrategy:void 0},f=0,p=null,h=null,m=null;if(Number.isFinite(u)?([l,u]=[u,l],console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),d.size=l,d.writableStrategy=u):u&&u.highWaterMark?(console.warn("[StreamSaver] Deprecated pass an object as 2nd argument when creating a write stream"),d.size=l,d.writableStrategy=u):d=u||{},!a){t||(t=o?c(s.mitm):function(t){const n="width=200,height=100",r=document.createDocumentFragment(),o={frame:e.open(t,"popup",n),loaded:!1,isIframe:!1,isPopup:!0,remove(){o.frame.close()},addEventListener(...e){r.addEventListener(...e)},dispatchEvent(...e){r.dispatchEvent(...e)},removeEventListener(...e){r.removeEventListener(...e)},postMessage(...e){o.frame.postMessage(...e)}},a=t=>{t.source===o.frame&&(o.loaded=!0,e.removeEventListener("message",a),o.dispatchEvent(new Event("load")))};return e.addEventListener("message",a),o}(s.mitm)),h=new MessageChannel,r=encodeURIComponent(r.replace(/\//g,":")).replace(/['()]/g,escape).replace(/\*/g,"%2A");const a={transferringReadable:n,pathname:d.pathname||Math.random().toString().slice(-6)+"/"+r,headers:{"Content-Type":"application/octet-stream; charset=utf-8","Content-Disposition":"attachment; filename*=UTF-8''"+r}};d.size&&(a.headers["Content-Length"]=d.size);const u=[a,"*",[h.port2]];if(n){const e="iframe"===i?void 0:{transform(e,t){if(!(e instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");f+=e.length,t.enqueue(e),p&&(location.href=p,p=null)},flush(){p&&(location.href=p)}};m=new s.TransformStream(e,d.writableStrategy,d.readableStrategy);const t=m.readable;h.port1.postMessage({readableStream:t},[t])}h.port1.onmessage=e=>{e.data.download?"navigate"===i?(t.remove(),t=null,f?location.href=e.data.download:p=e.data.download):(t.isPopup&&(t.remove(),t=null,"iframe"===i&&c(s.mitm)),c(e.data.download)):e.data.abort&&(w=[],h.port1.postMessage("abort"),h.port1.onmessage=null,h.port1.close(),h.port2.close(),h=null)},t.loaded?t.postMessage(...u):t.addEventListener("load",(()=>{t.postMessage(...u)}),{once:!0})}let w=[];return!a&&m&&m.writable||new s.WritableStream({write(e){if(!(e instanceof Uint8Array))throw new TypeError("Can only write Uint8Arrays");a?w.push(e):(h.port1.postMessage(e),f+=e.length,p&&(location.href=p,p=null))},close(){if(a){const e=new Blob(w,{type:"application/octet-stream; charset=utf-8"}),t=document.createElement("a");t.href=URL.createObjectURL(e),t.download=r,t.click()}else h.port1.postMessage("end")},abort(){w=[],h.port1.postMessage("abort"),h.port1.onmessage=null,h.port1.close(),h.port2.close(),h=null}},d.writableStrategy)},WritableStream:e.WritableStream||r.WritableStream,supported:!0,version:{full:"2.0.5",major:2,minor:0,dot:5},mitm:"https://jimmywarting.github.io/StreamSaver.js/mitm.html?version=2.0.0"};function c(e){if(!e)throw new Error("meh");const t=document.createElement("iframe");return t.hidden=!0,t.src=e,t.loaded=!1,t.name="iframe",t.isIframe=!0,t.postMessage=(...e)=>t.contentWindow.postMessage(...e),t.addEventListener("load",(()=>{t.loaded=!0}),{once:!0}),document.body.appendChild(t),t}try{new Response(new ReadableStream),o&&!("serviceWorker"in navigator)&&(a=!0)}catch(e){a=!0}return(e=>{try{e()}catch(e){}})((()=>{const{readable:e}=new TransformStream,t=new MessageChannel;t.port1.postMessage(e,[e]),t.port1.close(),t.port2.close(),n=!0,Object.defineProperty(s,"TransformStream",{configurable:!1,writable:!1,value:TransformStream})})),s},e.exports=t()}(p);var h=p.exports,m={openDB:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return new Promise((function(r,o){var a,i=(window.indexedDB||window.mozIndexedDB||window.webkitIndexedDB||window.msIndexedDB).open(e,n);i.onsuccess=function(e){a=e.target.result,r(a)},i.onupgradeneeded=function(e){(a=e.target.result).createObjectStore(t,{keyPath:"id",autoIncrement:!0})}}))},addData:function(e,t,n){e.transaction([t],"readwrite").objectStore(t).add(n)},cursorGetData:function(e,t){return new Promise((function(n,r){var o=new Map,a=e.transaction(t,"readwrite").objectStore(t).openCursor();a.onsuccess=function(e){var t=e.target.result;t?((new Date).valueOf()-t.value.saveTime>18e6?t.delete():o.set(t.value.key,t.value),t.continue()):n(o)},a.onerror=function(e){r(o)}}))},deleteAllDate:function(e,t,n){var r=this;return new Promise((function(o,a){r.cursorGetData(e,t).then((function(r){var a,s=e.transaction(t,"readwrite").objectStore(t),u=i(r);try{for(u.s();!(a=u.n()).done;){var l=c(a.value,2),d=l[0],f=l[1];d.indexOf("".concat(n.docId,"_").concat(n.docVersion,"_").concat(n.wmType))>-1&&(s.delete(d),s.delete(f.id))}}catch(e){u.e(e)}finally{u.f()}o()}))}))},getDataByIndex:function(e,t,n,r){return e.transaction(t,"readwrite").objectStore(t).index(n).get(r).onsuccess=function(e){return e.target.result},""},updateDB:function(e,t,n){e.transaction([t],"readwrite").objectStore(t).put(n)},closeDB:function(e){e.close()},deleteDBAll:function(e){indexedDB.deleteDatabase(e)}},w={status:500,message:"An exception occurred when initializing the document!"},g={status:500,message:"访问超时，请重新登录或联系IT人员;Access timed out. Please log in again or contact IT personnel."},v={status:90002,message:"The appId is not set!"},y={status:90006,message:"The document is empty!"},D={status:90008,message:"The token is invalid!"},S={status:90009,message:"No operation permission!"},k={status:12079,message:"Sorry , unable to download. please pass the KIA checkingfirst to download a file using public network.Current document is being checked by the KIA, please wait a while then redownload!"},T={status:403,message:"The document cannot be found. It may not exist."},b={status:404,message:"The network is exception. Check the network environment."},E={status:12081,message:"The file name cannot start with a dot."},I={status:12082,message:"文件下载失败，请检查网络情况与磁盘空间剩余情况。Failed to download the file. Check the network and available disk space."},N={status:12083,message:"You do not have the download permission or the source document information has been destroyed."},R={status:12085,message:"文件总大小超过批量下载上限.The total file size exceeds the upper limit for batch download."},C={status:12082,message:"Package download error: Some documents have been deleted or do not exist or are not allowed to be downloaded at the current site."},x={status:12086,message:"文件下载失败，分片合并完整性校验不通过。The file fails to be downloaded, and the integrity check for segment merging fails."},A={status:12096,message:"The file with size 0 is not allowed."},P={getRandomValue:function(){var e=new Uint32Array(1);return(window.crypto||window.msCrypto).getRandomValues(e),"ID"+e[0]},isEmpty:function(e){if(null==e)return!0;var t=d(e);return"string"===t&&e.trim().length<1||("object"===t&&void 0===e.length?"{}"===JSON.stringify(e):"object"===t&&void 0!==e.length&&e.length<1)},getProtocol:function(){return"https:"===location.protocol||"http:"===location.protocol?location.protocol:"https:"},uriParamFormat:function(e,t){if(e.indexOf("?")<0?e+="?":e.endsWith("&")||(e+="&"),"object"===d(t)&&"{}"!==JSON.stringify(t)&&"[]"!==JSON.stringify(t)){for(var n in t)e=e+n+"="+t[n]+"&";e=e.substring(0,e.length-1)}return e},formatURL:function(e,t){if(null!=e)for(var n in t.indexOf("?")<0&&(t+="?"),e)null!==e[n]&&void 0!==e[n]&&""!==e[n]&&(t=t+n+"="+e[n]+"&");return t},parseUrlQuery:function(e){var t={},n=e.match(/[?&]([^=&#]+)=([^&#]*)/g);if(n)for(var r=0;r<n.length;r++){var o=n[r].indexOf("="),a=n[r].substring(1,o),i=n[r].substring(o+1);t[a]?t[a]=[].concat(t[a],i):t[a]=i}return t},setRequestEdmTokenQueryBody:function(e,t){var n=P.parseUrlQuery(e);for(var r in t)n[r]=t[r];return n},newXMLHttpRequest:function(e){var t;if(e="boolean"!=typeof e||e,"undefined"!=typeof XMLHttpRequest)try{return(t=new XMLHttpRequest).withCredentials=!!e,t}catch(e){t=!1}if(!t)try{t=new ActiveXObject("Msxml2.XMLHTTP")}catch(e){try{t=new ActiveXObject("Microsoft.XMLHTTP")}catch(e){}}return"withCredentials"in t?t.withCredentials=!!e:e&&(t=new XDomainRequest),t},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},getValueArr:function(e){var t=Object.keys(e);return Object.keys(t).map((function(e){return t[e]}))},getOnLine:function(){try{var e=new XMLHttpRequest;return e.open("get","".concat(location.href),!1),e.send(),200===e.status}catch(e){return!1}},getTimestamp:function(){var e=new Date;return"_t="+e.getFullYear()+"".concat(e.getMonth()+1)+e.getDate()},getPreciseTimestamp:function(){var e=60*(0-(new Date).getTimezoneOffset())*1e3;return new Date(Date.now()+e).toISOString().replace(/[-T:.Z]/g,"")},simpleDeepClone:function(e){return JSON.parse(JSON.stringify(e))},upperCompare:function(e,t){return e.toUpperCase()===t.toUpperCase()}},H=function(){return a((function e(){r(this,e),this.crc=-1}),[{key:"append",value:function(e){for(var t=0|this.crc,n=this.table,r=0,o=0|e.length;r<o;r++)t=t>>>8^n[255&(t^e[r])];this.crc=t}},{key:"get",value:function(){return~this.crc}}])}();H.prototype.table=function(){var e,t,n,r=[];for(e=0;e<256;e++){for(n=e,t=0;t<8;t++)n=1&n?n>>>1^3988292384:n>>>1;r[e]=n}return r}();var O=function(e){var t=new Uint8Array(e);return{array:t,view:new DataView(t.buffer)}};function L(e,t,n,r){var o,a,i,s=0,c=0,u=e.length,l=!1;for(o=0;o<u;o++)s+=46+(a=t[e[o]]).nameBuf.length+a.comment.length,a.extraArray&&(s+=a.extraArray.length,l=!0);((i=n)+s>=4294967295||u>=65535)&&(l=!0);var d=O(s+(l?76:0)+22);for(o=0;o<u;o++){a=t[e[o]],d.view.setUint32(c,1347092738),d.view.setUint16(c+4,5120),d.array.set(a.header.array,c+6),a.extraArray&&d.view.setUint16(c+30,a.extraArray.length,!0),d.view.setUint16(c+32,a.comment.length,!0),a.directory&&d.view.setUint8(c+38,16),a.offset>=4294967295?d.view.setUint32(c+42,4294967295,!0):d.view.setUint32(c+42,a.offset,!0),d.array.set(a.nameBuf,c+46);var f=0;a.extraArray&&(f=a.extraArray.length,d.array.set(a.extraArray,c+46+a.nameBuf.length)),d.array.set(a.comment,c+46+a.nameBuf.length+f),c+=46+a.nameBuf.length+a.comment.length+f}l&&(d.view.setUint32(c,1347094022),d.view.setBigUint64(c+4,BigInt(44),!0),d.view.setUint16(c+12,45,!0),d.view.setUint16(c+14,45,!0),d.view.setBigUint64(c+24,BigInt(u),!0),d.view.setBigUint64(c+32,BigInt(u),!0),d.view.setBigUint64(c+40,BigInt(s),!0),d.view.setBigUint64(c+48,BigInt(i),!0),c+=56,d.view.setUint32(c,1347094023),d.view.setBigUint64(c+8,BigInt(i+s),!0),d.view.setUint32(c+16,1,!0),c+=20,u=65535,i=4294967295),d.view.setUint32(c,1347093766),d.view.setUint16(c+8,u,!0),d.view.setUint16(c+10,u,!0),d.view.setUint32(c+12,s,!0),d.view.setUint32(c+16,i,!0),r.enqueue(d.array),r.close()}function U(e,t,n,r){if(e.setRequestHeader(t.HEADERS.APP_ID,n.appId),e.setRequestHeader(t.HEADERS.TRACE_ID,n.requestTrace+Date.now()),0===n.enterpriseDocumentToken.indexOf("Basic")?(e.setRequestHeader(t.HEADERS.OLD_TOKEN,n.enterpriseDocumentToken),e.setRequestHeader("x-csrf-token",n.xCsrfToken),e.setRequestHeader(t.HEADERS.API_ALIAS,t.apiParams.apiAliasSingle)):(e.setRequestHeader(t.HEADERS.TOKEN,n.enterpriseDocumentToken),e.setRequestHeader("x-csrf-token",n.xCsrfToken)),r&&r.fileName&&"string"==typeof r.fileName){if(!n.checkPoint(r.fileName))return;e.setRequestHeader("fileName",encodeURIComponent(r.fileName))}}window.ZIP=function(e){var t,n,r,o=0,a=0,i=0,s=!1,c=Object.create(null),u=[],l=new TextEncoder;function d(){a++,(n=c[u[a]])?p():r&&L(u,c,o,t)}var f={enqueue:function(e){if(r)throw new TypeError("Cannot enqueue a chunk into a readable stream that is closed or has been requested to be closed");var a=e.name.trim(),f=new Date(void 0===e.lastModified?Date.now():e.lastModified);if(e.directory&&!a.endsWith("/")&&(a+="/"),c[a])throw new Error("File already exists.");i+=e.size,s=i>=4294967295;var h=l.encode(a);u.push(a);var m=c[a]={writeHeader:function(){o+=function(e){var t=e.zipObject,n=e.nameBuf,r=e.date,o=e.offset,a=e.ctrl,i=e.zip64,s=O(26),c=O(30+n.length);return t.header=s,t.offset=o,0===t.level||t.directory||s.view.setUint16(4,2048),s.view.setUint32(0,335546376),i&&s.view.setUint16(0,45,!0),s.view.setUint16(6,(r.getHours()<<6|r.getMinutes())<<5|r.getSeconds()/2,!0),s.view.setUint16(8,(r.getFullYear()-1980<<4|r.getMonth()+1)<<5|r.getDate(),!0),s.view.setUint16(22,n.length,!0),c.view.setUint32(0,1347093252),c.array.set(s.array,4),c.array.set(n,30),a.enqueue(c.array),c.array.length}({zipObject:m,nameBuf:h,date:f,offset:o,ctrl:t,zip64:s})},writeFooter:function(){o+=function(e){var t=e.zipObject,n=e.files,r=e.ctrl,o=e.zip64,a=e.name;t.compressedLength&&t.compressedLength>=4294967295&&(t.header.view.setUint16(0,45),o=!0);var i=O(o?24:16);if(i.view.setUint32(0,1347094280),t.crc&&(t.header.view.setUint32(10,t.crc.get(),!0),i.view.setUint32(4,t.crc.get(),!0)),o){var s=O(28);t.header.view.setUint32(14,4294967295,!0),t.header.view.setUint32(18,4294967295,!0),i.view.setBigUint64(8,BigInt(t.compressedLength),!0),i.view.setBigInt64(16,BigInt(t.uncompressedLength),!0),s.view.setUint16(0,1,!0),s.view.setUint16(2,24,!0),s.view.setBigUint64(4,BigInt(t.uncompressedLength),!0),s.view.setBigUint64(12,BigInt(t.compressedLength),!0),s.view.setBigUint64(20,BigInt(n[a].offset),!0),t.extraArray=s.array}else t.header.view.setUint32(14,t.compressedLength,!0),t.header.view.setUint32(18,t.uncompressedLength,!0),i.view.setUint32(8,t.compressedLength,!0),i.view.setUint32(12,t.uncompressedLength,!0);return r.enqueue(i.array),t.compressedLength+i.array.length}({zipObject:m,files:c,ctrl:t,zip64:s,name:a}),d()},level:0,ctrl:t,comment:l.encode(e.comment||""),compressedLength:0,directory:!!e.directory,nameBuf:h,uncompressedLength:0,extraArray:null,fileLike:e};n||(n=m,p())},close:function(){if(r)throw new TypeError("Cannot close a readable stream that has already been requested to be closed");n||L(u,c,o,t),r=!0}};function p(){var e;if(n)return n.directory?n.writeFooter(n.writeHeader()):n.reader?(e=n).reader.read().then((function(t){if(t.done)return e.writeFooter();var n=t.value;e.crc.append(n),e.uncompressedLength+=n.length,e.compressedLength+=n.length,e.ctrl.enqueue(n)})):void(n.fileLike.stream?(n.crc=new H,n.reader=n.fileLike.stream().getReader(),n.writeHeader()):d())}return new ReadableStream({start:function(n){t=n,e.start&&Promise.resolve(e.start(f))},pull:function(){return p()||e.pull&&Promise.resolve(e.pull(f))}})};var M=function(){return a((function e(t,n){r(this,e),this.file=t,this.packInstance=n,this.runningCount=0,this.runningXhr=new Map,this.allXhrSize=new Map,this.result=[],this.limit=t.downloadChunkGroupSize||5,this.chunkSize=1024*(t.downloadChunkSize||this.packInstance.EdmUtils.CHUNK_ATOM)*1024,this.chunkNum=0,this.maxRetryTime=3,this.sliceList=[],this.tokenRetryTime=0,this.loadSize=0,this.aborted=!1}),[{key:"getUrl",value:function(e){var t=this.file,n=this.packInstance.instance,r=P.simpleDeepClone(e);r.file=null;var o=n.edmServiceDomain+n.contextPath.single;return o=(o=(o=(o=(o=o.replace("{docId}",t.docId)).replace("{docVersion}",t.docVersion)).replace("{wmType}",t.wmType||"")).replace("{decryptKey}",t.decryptKey||""))+"&_t="+(new Date).getTime(),n.userId&&(r.userId=n.userId),o=P.uriParamFormat(o,r)}},{key:"slice",value:function(){var e=[],t=Math.ceil(this.file.fileSize/this.chunkSize);this.chunkNum=t;for(var n=0;n<t;n++){var r={index:n,chunkNum:n+1,file:this.file,Progress:0,startRange:n*this.chunkSize,endRange:n+1===t?this.file.fileSize-1:(n+1)*this.chunkSize-1,complete:!1,retryTime:0};e.push(r)}return e}},{key:"download",value:function(){var e=this;this.sliceList=this.slice();var t=Math.min(this.limit,this.packInstance.maxRunningCount-this.packInstance.runningCount);return new Promise((function(n,r){for(var o=0;o<t;o++)e.concurrentDownload(n,r)}))}},{key:"abort",value:function(){this.aborted||(this.aborted=!0,this.runningXhr.forEach((function(e,t){e.abort()})))}},{key:"concurrentDownload",value:function(e,t){var r=this;if(!(this.runningCount>this.limit||this.packInstance.maxRunningCount-this.packInstance.runningCount<=0||this.aborted)){var o=this.sliceList.shift();if(o)this.runningCount++,this.packInstance.runningCount++,this.sliceDownload(o).then((function(e){r.packInstance.runningCount--,r.result.push(e)})).catch(function(){var e=n(s().mark((function e(n){return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.packInstance.runningCount--,e.next=3,r.handleErr(n,t);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()).finally((function(){r.runningXhr.delete(o.index),r.runningCount--,r.updateProgress();for(var n=Math.min(r.limit,r.packInstance.maxRunningCount-r.packInstance.runningCount),a=0;a<n;a++)r.concurrentDownload(e,t)}));else if(0===this.runningCount&&!this.aborted){this.result.sort((function(e,t){return e.index-t.index}));var a=new Blob(this.result.map((function(e){return e.data})),{type:"application/octet-stream"});a.size===this.file.fileSize?e(a):t(x)}}}},{key:"sliceDownload",value:function(e){var t=this;return new Promise((function(n,r){var o=t.packInstance.instance,a=t.packInstance.EdmUtils,i=t.file,s=t.getUrl(e),c=P.newXMLHttpRequest(o.withCredentials);c.open("GET",s,!0),c.responseType="blob",U(c,a,o,i),c.onreadystatechange=function(t){if(4===c.readyState)if(200===c.status){var o=c.response.type;if("application/octet-stream"===o)n({index:e.index,data:c.response});else if("application/json"===o){var a=new FileReader;a.readAsText(c.response,"utf-8"),a.onload=function(e){r({type:"JSON",response:JSON.parse(e.target.result)})}}}else r({slice:e,errStatus:c.status})},t.runningXhr.set(e.index,c),c.addEventListener("progress",(function(n){t.allXhrSize.set(e.index,n.loaded),t.updateProgress()}),!1),c.send()}))}},{key:"handleErr",value:(e=n(s().mark((function e(t,n){var r,o,a,i;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.errStatus,o=t.slice,a=t.type,i=t.response,"JSON"!==a){e.next=5;break}return 12079===i.status?n(k):i.message?n({status:i.status,message:i.message}):n(w),this.abort(),e.abrupt("return");case 5:if(401!==r){e.next=19;break}return e.prev=6,e.next=9,this.tokenRetry();case 9:e.sent&&this.sliceList.unshift(o),e.next=17;break;case 13:e.prev=13,e.t0=e.catch(6),this.abort(),n(e.t0);case 17:e.next=20;break;case 19:0===r?this.aborted?n({status:0,message:"取消下载。Cancel Download."}):(this.abort(),n(I)):o.retryTime<this.packInstance.EdmUtils.REPLAY_LIMIT?(o.retryTime++,this.sliceList.push(o)):(this.abort(),n({status:500,message:"".concat(o.index,"分片超过最大重试次数，终止").concat(o.file.docId,"下载.The number of segment retries exceeds the maximum. The download is terminated.")}));case 20:case"end":return e.stop()}}),e,this,[[6,13]])}))),function(t,n){return e.apply(this,arguments)})},{key:"tokenRetry",value:function(){var e=this;return new Promise((function(t,n){e.tokenRetryTime>e.packInstance.EdmUtils.TOKEN_REPLAY_LIMIT?n(D):(e.tokenRetryTime+=1,e.packInstance.instance.requestEdmToken(!0,[e.file]).then((function(n){n?(e.tokenRetryTime=0,t(!0)):t(e.tokenRetry())})))}))}},{key:"updateProgress",value:function(){var e=0;this.allXhrSize.forEach((function(t){e+=t})),this.loadSize=e,this.packInstance.updateProgress()}}]);var e}(),_=function(){return a((function e(t,n){r(this,e),this.file=t,this.packInstance=n,this.xhr=null,this.aborted=!1,this.tokenRetryTime=0,this.loadSize=0,this.limit=1}),[{key:"getUrl",value:function(){var e=this.file,t=this.packInstance.instance,n=t.edmServiceDomain+t.contextPath.single;if(n=(n=(n=(n=(n=n.replace("{docId}",e.docId)).replace("{docVersion}",e.docVersion)).replace("{wmType}",e.wmType||"")).replace("{decryptKey}",e.decryptKey||""))+"&_t="+(new Date).getTime(),t.userId){var r={};r.userId=t.userId,n=P.uriParamFormat(n,r)}return n}},{key:"download",value:function(){var e=this;return new Promise((function(t,n){var r=e,o=e.packInstance.instance,a=e.packInstance.EdmUtils,i=e.file,s=e.getUrl();e.packInstance.runningCount++;var c=P.newXMLHttpRequest(o.withCredentials);c.onreadystatechange=function(e){if(4===c.readyState)if(200===c.status){var o=c.response.type;if("application/octet-stream"===o)t(c.response);else if("application/json"===o){var a=new FileReader;a.readAsText(c.response,"utf-8"),a.onload=function(e){var t=e.target.result,r=JSON.parse(t);12079===r.status?n(k):r.message?n({status:r.status,message:r.message}):n(w)}}}else 401===c.status?r.tokenRetry(t,n):0===c.status?r.aborted?n({status:0,message:"取消下载。Cancel Download."}):n(I):n(w)},c.open("GET",s,!0),c.responseType="blob",U(c,a,o,i),c.addEventListener("progress",(function(e){r.updateProgress(e.loaded)}),!1),e.xhr=c,c.send()}))}},{key:"tokenRetry",value:function(e,t){var n=this;this.tokenRetryTime>this.packInstance.EdmUtils.TOKEN_REPLAY_LIMIT?t(D):(this.tokenRetryTime+=1,this.packInstance.instance.requestEdmToken(!0,[this.file]).then((function(r){r?(n.packInstance.runningCount--,e(n.download())):n.tokenRetry(e,t)})))}},{key:"updateProgress",value:function(e){this.loadSize=e,this.packInstance.updateProgress()}},{key:"abort",value:function(){this.aborted=!0,this.xhr.abort()}}])}(),F={code:0,message:"The download is canceled,下载被取消"},q={code:102,message:"Downloading;正在下载中"},z={code:200,message:"Download complete;下载完成"},j={code:500,message:"Download failed;下载失败"},B=function(){return a((function e(t,n,o,a,i){r(this,e),this.instance=n,this.EdmUtils=o,this.ID=a,this.NetID=i,this.list=u(t),this.result={},this.packDocs=new Map,this.nameSet=new Set,this.allSize=0,this.downloadedSize=0,this.writer=null,this.aborted=!1,this.complete=!1,this.runningCount=0,this.maxRunningCount=6,this.tempSize=0,this.runningFile=new Set}),[{key:"getFileName",value:function(e,t){var n;if(e.customPath)if(e.customPath=e.customPath+"/",e.customPath=e.customPath.replace(/(\/)+/g,"/"),0===e.customPath.indexOf("/")&&(e.customPath=e.customPath.slice(1)),e.fileName){var r=e.fileName.lastIndexOf("/");n=r>-1?e.customPath+e.fileName.slice(r+1):e.customPath+e.fileName}else n=e.customPath+e.docName;else n=e.fileName?e.fileName:e.docName;return n=this.handleFileSuffix(n,t),n=this.handleDuplicateName(n)}},{key:"handleFileSuffix",value:function(e,t){var n=e.lastIndexOf(".");return n>-1?e.slice(0,n)+t:e+t}},{key:"handleDuplicateName",value:function(e){var t;if(this.nameSet.has(e)){var n=e.lastIndexOf("."),r=P.getPreciseTimestamp();t=n>-1?e.slice(0,n)+"_"+r+e.slice(n):e+"_"+r}else this.nameSet.add(e),t=e;return t}},{key:"getQueryDocsParams",value:function(){for(var e=new Set,t={docInfoVO:{ids:[],docType:"all",docVersion:""}},n=0;n<this.list.length;n++)e.add(this.list[n].docId);return t.docInfoVO.ids=Array.from(e),t}},{key:"queryDocsInfo",value:function(){var e=this;return new Promise((function(t,n){var r=e.EdmUtils,o=e.instance,a=o.edmServiceDomain+o.contextPath.querying,i=P.newXMLHttpRequest(o.withCredentials);i.onreadystatechange=function(e){if(4===i.readyState)if(200===i.status)try{var r=JSON.parse(i.response);200===r.status?t(r.result.outDocQueryList):n({status:r.status,message:r.message})}catch(e){n(e)}else n({status:i.status,response:i.response})},i.open("POST",a,!0),i.setRequestHeader("Content-Type","application/json"),U(i,r,o);var s=e.getQueryDocsParams();i.send(JSON.stringify(s))}))}},{key:"getDocInfoByVerAndwmType",value:function(e,t,n,r){P.isEmpty(r)&&(r="src"),r=r.toUpperCase();var o=e.filter((function(e){return e.id===t}))[0];if(P.isEmpty(n)){var a=o.verInfo.sort((function(e,t){return t.version.slice(1)-e.version.slice(1)}));n=a[0].version}var i,s=o.verInfo.filter((function(e){return P.upperCompare(e.version,n)}))[0].docInfo;if("IWM"===r||"WM"===r){var c=s.filter((function(e){return!!e.wmType&&P.upperCompare(e.wmType,"IWM")}))[0],u=s.filter((function(e){return!!e.wmType&&P.upperCompare(e.wmType,"WM")}))[0];i="IWM"===r?c||u:u||c}else i=s.filter((function(e){return e.wmType?P.upperCompare(e.wmType,r):P.upperCompare(e.docType,r)}))[0];return o.downloadChunkGroupSize&&(i.downloadChunkGroupSize=o.downloadChunkGroupSize),o.downloadChunkSize&&(i.downloadChunkSize=o.downloadChunkSize),i}},{key:"handleTpdDocs",value:function(e){for(var t=[],n=0;n<this.list.length;n++){var r=this.list[n];if(r.wmType&&P.upperCompare(r.wmType,"TPD")){var o=this.getAttachmentDocs(e,r.docId,r.docVersion);if(0===o.length)return this.instance.fail(C,this.list),!1;t.push.apply(t,u(o))}else t.push(r)}return this.list=t,!0}},{key:"getAttachmentDocs",value:function(e,t,n){var r=[],o=e.filter((function(e){return e.id===t}))[0];if(P.isEmpty(n)){var a=o.verInfo.sort((function(e,t){return t.version.slice(1)-e.version.slice(1)}));n=a[0].version}return o.verInfo.filter((function(e){return P.upperCompare(e.version,n)}))[0].docInfo.forEach((function(e){if(e.wmType){var t={appId:e.appId,docId:e.docId,docName:e.docName,docVersion:e.docVersion,fileName:e.fileName,wmType:e.wmType};r.push(t)}})),r}},{key:"setDocInfo",value:function(e){for(var t=this.list,n=0;n<t.length;n++){var r=this.getDocInfoByVerAndwmType(e,t[n].docId,t[n].docVersion,t[n].wmType),o="".concat(t[n].docId,"_").concat(t[n].docVersion,"_").concat(t[n].wmType);this.packDocs.set(o,r)}}},{key:"checkDocName",value:function(e){for(var t=this,n=this.list,r=function(r){var o=e.filter((function(e){return e.id===n[r].docId}));o.length>0&&(t.list[r].docName=o[0].verInfo[0].docInfo[0].docName)},o=0;o<n.length;o++)r(o)}},{key:"failRetry",value:function(e){var t=this,n=Object.values(this.result).filter((function(e){return!e.success}));confirm("".concat(n.length,"个文件下载失败：\n").concat(n.map((function(e){return e.docId})).join(),"\n失败文件是否重新下载？不重新下载将只打包已成功下载的文件。"))?(n.forEach((function(e){t.list.push(e)})),this.seriesDownload(e)):(Object.values(this.result).length===n.length&&this.writer.abort("全部文件下载失败取消生成zip包"),e.close(),this.updateProgress(this.allSize))}},{key:"createDownloadFile",value:function(e){return e.fileSize>1024*this.EdmUtils.CHUNK_LIMIT*1024?new M(e,this):new _(e,this)}},{key:"seriesDownload",value:function(e){var t=this;if(!(this.runningCount>=this.maxRunningCount||this.aborted)){var n=this.list.shift();if(n){var r="".concat(n.docId,"_").concat(n.docVersion,"_").concat(n.wmType),o=this.packDocs.get(r),a=this.createDownloadFile(o),i=this.getFileName(n,o.docSuffix);this.runningFile.add(a),a.download().then((function(r){n.success=!0,e.enqueue({name:i,size:r.size,stream:function(){return r.stream()}}),t.downloadedSize+=r.size})).catch((function(e){if(e.status===I)return t.abort(!0),void t.instance.fail(I,t.list);t.nameSet.delete(i),n.success=!1,n.error=e})).finally((function(){o.fileSize<=1024*t.EdmUtils.CHUNK_LIMIT*1024&&t.runningCount--,t.runningFile.delete(a),t.updateProgress(),t.result[r]=n,t.seriesDownload(e)})),setTimeout((function(){t.seriesDownload(e)}),1)}else{if(0===this.runningCount)Object.values(this.result).filter((function(e){return!e.success})).length>0?this.failRetry(e):e.close()}}}},{key:"setAllSize",value:function(){var e,t=i(this.list);try{for(t.s();!(e=t.n()).done;){var n=e.value,r="".concat(n.docId,"_").concat(n.docVersion,"_").concat(n.wmType),o=this.packDocs.get(r);this.allSize+=o.fileSize}}catch(e){t.e(e)}finally{t.f()}}},{key:"checkLimit",value:(e=n(s().mark((function e(){var t,n,r,o,a;return s().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=1073741824,n=navigator.userAgent.indexOf("Android")>-1||navigator.userAgent.indexOf("Adr")>-1,e.next=5,navigator.storage.estimate();case 5:if(!((r=e.sent.quota)<2*t)){e.next=13;break}if(!(this.allSize>2*t)){e.next=10;break}return e.abrupt("return",!1);case 10:case 17:case 23:return e.abrupt("return",!0);case 13:if(!n){e.next=20;break}if(o=r/.6*.06,!(this.allSize>o)){e.next=17;break}return e.abrupt("return",!1);case 20:if(a=r/.6*.1,!(this.allSize>a)){e.next=23;break}return e.abrupt("return",!1);case 24:e.next=29;break;case 26:return e.prev=26,e.t0=e.catch(0),e.abrupt("return",!0);case 29:case"end":return e.stop()}}),e,this,[[0,26]])}))),function(){return e.apply(this,arguments)})},{key:"checkException",value:function(e){for(var t=this,n="Package download error:\n",r=!1,o=[],a=[],i=function(){var n=e[s],r=n.verInfo,i=n.id;if(0===r.length)o.push(i);else{var c=t.list.filter((function(e){return i===e.docId}))[0],u=t.getDocInfoByVerAndwmType(e,i,c.docVersion,c.wmType);u&&10===u.docStatus&&a.push(i)}},s=0;s<e.length;s++)i();return o.length>0&&(n+="".concat(o.join(",")," have been destroy or do not exist or do not have the share permission.\n"),r=!0),a.length>0&&(n+="".concat(a.join(",")," have been deleted.\n"),r=!0),!!r&&(this.instance.fail({status:12082,message:n},this.list),!0)}},{key:"download",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,r=this;this.queryDocsInfo().then(function(){var t=n(s().mark((function t(o){var a,i,c,u,l,d;return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.handleTpdDocs(o)){t.next=5;break}return e.instance.handleProgress(e.allSize),e.updateStatus(j),t.abrupt("return");case 5:if(!e.checkException(o)){t.next=10;break}return e.instance.handleProgress(e.allSize),e.updateStatus(j),t.abrupt("return");case 10:return e.checkDocName(o),e.setDocInfo(o),e.setAllSize(),t.next=15,e.checkLimit();case 15:if(t.sent){t.next=19;break}return e.instance.fail(R,e.list),t.abrupt("return");case 19:a=P.getPreciseTimestamp()+".zip",i=h.createWriteStream(a),c=i.getWriter(),e.writer=c,e.instance.writer=c,u=new ZIP({start:function(e){return n(s().mark((function t(){return s().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:r.seriesDownload(e);case 1:case"end":return t.stop()}}),t)})))()}}),l=u.getReader(),(d=function(){return l.read().then((function(t){t.done?(c.close(),e.finish()):c.write(t.value).then(d).catch((function(e){}))}))})(),e.updateStatus(q);case 29:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()).catch((function(n){if(0===n.status)t<e.EdmUtils.REPLAY_LIMIT?(t++,e.download(t)):e.instance.fail(b,e.list);else if(403===n.status)try{var r=JSON.parse(n.response);void 0!==r.message?e.instance.fail({status:r.status,message:r.message},e.list):e.instance.fail(S,e.list)}catch(n){e.instance.fail(S,e.list)}else n.message?e.instance.fail(n,e.list):e.instance.fail(w,e.list)}))}},{key:"updateStatus",value:function(e){this.EdmUtils.updateDocStatus(this.ID,this.NetID,e.code,e.message)}},{key:"updateProgress",value:function(e){this.aborted&&(e=this.allSize);var t=0;if(0===this.allSize)t=1;else if(e)t=e/this.allSize;else{var n=0;if(this.runningFile.size>0){var r,o=i(this.runningFile);try{for(o.s();!(r=o.n()).done;){n+=r.value.loadSize}}catch(e){o.e(e)}finally{o.f()}}if(n+=this.downloadedSize,this.tempSize>n)return;this.tempSize=n,(t=n/this.allSize)>1&&(t=1)}t=(100*t).toFixed(2),this.instance.handleProgress(t)}},{key:"abort",value:function(e){if(!this.complete&&!this.aborted){if(this.writer&&this.writer.abort(e?"失败自动取消下载":"用户取消下载"),this.runningFile.size>0){var t,n=i(this.runningFile);try{for(n.s();!(t=n.n()).done;){t.value.abort()}}catch(e){n.e(e)}finally{n.f()}}this.aborted=!0,this.updateProgress(this.allSize),this.updateStatus(F)}}},{key:"finish",value:function(){this.updateStatus(z),this.complete=!0,this.instance.finish&&this.instance.finish(this.instance.cacheDocuments)}}]);var e}();function K(e,t,n,r,o){var a=new B(e,t,n,r,o);t.cacheDocuments[o].xhr={abort:a.abort.bind(a)},a.download()}var V={},Q={NetworkSpeedObject:{},TemnetworkSpeed:0,Firstflag:!0,clientPackFlag:void 0,NetSpeedInterval:null,envs:{cloudblue:{prod:"http://apig.heds.hihonor.com/api/edm",beta:"http://hicuat.huawei.com/edm"},internal:{prod:"".concat(P.getProtocol(),"//edm3.huawei.com/edm"),beta:"".concat(P.getProtocol(),"//edm3-beta.huawei.com/edm")},apigw:{beta:"http://edm3-dmz-beta.his.huawei.com/edm",prod:"http://edm3-dmz.his.huawei.com/edm/"}},isIE:!!window.ActiveXObject||"ActiveXObject"in window,EMPTY:"",TOKEN_REPLAY_LIMIT:50,REPLAY_LIMIT:3,CHUNK_LIMIT:50,CHUNK_ATOM:8,CHUNK_BATCH_LIMIT:4,HEADERS:{APP_ID:"x-app-id",TRACE_ID:"x-trace-id",TOKEN:"EDM-Authorization",CONTENT_TYPE:"Content-Type",API_ALIAS:"apiAlias",OLD_TOKEN:"Authorization"},TOKEN_PAMETERS:{action:"edmTest",serverType:"download"},apiParams:{apiAliasSingle:"EDM3.edm.projects._project_id_.documents._doc_id_.get",apiAliasBatch:"EDM3.edm.projects._project_id_.packages.documents.post"},stopDonwload:function(e,t){!0!==V[e].cacheDocuments[t].abort||Q.updateDocStatus(e,t,0,"The download is canceled,下载被取消")},isEmptyOp:function(e){return P.isEmpty(V[e])?(V[e].unavailableInstance=!0,V[e]={},!0):(V[e].unavailableInstance=!1,!1)},isEmptyAppId:function(e){return!!P.isEmpty(V[e].appId)&&(V[e].unavailableInstance=!0,V[e].fail(v),!0)},setFail:function(e){P.isEmpty(V[e].fail)&&(V[e].fail=function(e){return e})},setNetworkSpeed:function(e){V[e].networkSpeed=V[e].networkSpeed,null!==V[e].networkSpeed&&void 0!==V[e].networkSpeed&&"function"==typeof V[e].networkSpeed||(V[e].networkSpeed=function(e){return e})},setStatusCallback:function(e){V[e].downloadStatus=V[e].status,P.isEmpty(V[e].downloadStatus)&&(V[e].downloadStatus=function(e){return e})},setServiceDomain:function(e){for(var t in V[e].edmServiceDomain=V[e].endPoint,P.isEmpty(V[e].edmServiceDomain)&&(P.isEmpty(V[e].env)||P.isEmpty(Q.envs[V[e].network][V[e].env])?V[e].edmServiceDomain=Q.envs[V[e].network].beta:V[e].edmServiceDomain=Q.envs[V[e].network][V[e].env]),Q.getChunkAtom(V[e].chunkAtom),V[e].contextPath={single:"/projects/{appId}/documents/{docId}?docVersion={docVersion}&wmType={wmType}&decryptKey={decryptKey}",zip:"/projects/{appId}/packages/documents?type=package",querying:"/projects/{appId}/tasks?action=query",token:"/projects/{appId}/tokens",asyncPackages:"/v1/projects/{appId}/async/packages?type=package",clientPackSwitch:"/projects/{appId}/client/batchDocDownload/enable"},V[e].tokenMethod=V[e].tokenMethod||"GET",V[e].https=!!V[e].https,V[e].appId=V[e].appId,V[e].breakWhenError=!!V[e].breakWhenError,V[e].uuid=V[e].uuid,V[e].enterpriseDocumentToken="",V[e].requestTrace="",V[e].tokenReplayCount=0,V[e].ReplayCount=0,V[e].netExceptionFlag=!1,V[e].apigw=V[e].apigw||null,V[e].sdkDomainHeader=V[e].sdkDomainHeader||null,V[e].pushAppMsg=V[e].pushAppMsg||null,V[e].asyncPackages=V[e].asyncPackages||!1,V[e].downloadType=V[e].downloadType||"default",V[e].contextPath)V[e].contextPath[t]=V[e].contextPath[t].replace("{appId}",V[e].appId);V[e].https&&(V[e].edmServiceDomain=V[e].edmServiceDomain.replace("http://","https://")),h.mitm=V[e].edmServiceDomain.slice(0,V[e].edmServiceDomain.length-3)+"edm3client/".concat("internal"===V[e].network?"packages/":"","webview/commons/js/mitm.html"),-1!==h.mitm.indexOf("http://")&&(h.mitm=h.mitm.replace("http://","https://")),V[e].tokenDomain=V[e].sdkDomain||V[e].edmServiceDomain+V[e].contextPath.token},setResponseErrorResolve:function(e){V[e].responseErrorResolve=function(t,n,r){if(401!==n.status){if(403===n.status){var o=n.response;if("blob"===n.responseType){var a=new FileReader;a.readAsText(n.response,"utf-8"),a.onload=function(n){o=JSON.parse(n.target.result),V[e].fail({status:o.status,message:o.message},t)}}else"string"==typeof o&&(o=JSON.parse(o)),void 0!==o.message?V[e].fail({status:o.status,message:o.message},t):V[e].fail(S,t);return Q.EMPTY}return 12079===n.status?(V[e].fail(k,t),Q.EMPTY):(V[e].fail(w,t),Q.EMPTY)}if(V[e].tokenReplayCount>=Q.TOKEN_REPLAY_LIMIT)return V[e].fail(D,t),Q.EMPTY;V[e].tokenReplayCount=V[e].tokenReplayCount+1,V[e].requestEdmToken(!0,t).then((function(e){return e?r():Q.EMPTY}))}},setRequestEdmTokenParams:function(e,t){var n={appId:V[e].appId,serverType:Q.TOKEN_PAMETERS.serverType};if(t){if("POST"===V[e].tokenMethod&&!0===V[e].isBatchDocid){for(var r=[],o=0;o<t.length;o++)r.push({docId:t[o].docId,wmType:t[o].wmType||"",docVersion:t[o].docVersion});n.docList=r,V[e].userPermissionsExt&&(n.userPermissionsExt=V[e].userPermissionsExt)}else n.docId=t[0].docId,n.docVersion=t[0].docVersion,n.wmType=t[0].wmType||"",V[e].userPermissionsExt&&(n.userPermissionsExt=JSON.stringify(V[e].userPermissionsExt));n.decryptKey=t[0].decryptKey||"",n.paraSah256="edm"}var a=V[e].sdkDomainParame||{};for(var i in"[object Object]"!==Object.prototype.toString(a)&&(a={}),a)n[i]||(n[i]=a[i]);return n},downloadFilterDupFields:function(e){var t=P.parseUrlQuery(e),n={};for(var r in t)n[r]||("object"===d(t[r])&&t[r].length>1?n[r]=t[r][0]:n[r]=t[r]);return e=-1!==e.indexOf("?")?e.substring(0,e.indexOf("?")):e,P.uriParamFormat(e,n)},serRequestEdmTokenIfGEt:function(e,t,n){var r=t;return"GET"===V[e].tokenMethod&&(r=P.uriParamFormat(r,n)),Q.downloadFilterDupFields(r)},setRequestEdmToken:function(e){V[e].requestEdmToken=function(t,n){return new Promise((function(r,o){if(V[e].unavailableInstance)return r(!1);if(V[e].generateToken)return V[e].enterpriseDocumentToken=V[e].generateToken(),V[e].requestTrace="edm3.js.sdk."+(new Date).getTime(),r(!0);if(!t&&!P.isEmpty(V[e].enterpriseDocumentToken))return r(!0);t&&(V[e].enterpriseDocumentToken="",V[e].requestTrace="");var a=P.newXMLHttpRequest(!0),i=V[e].tokenDomain,s=Q.setRequestEdmTokenParams(e,n);if(i=Q.serRequestEdmTokenIfGEt(e,i,s),a.open(V[e].tokenMethod,i,!0),V[e].sdkDomainHeader)for(var c=P.getValueArr(V[e].sdkDomainHeader),u=0;u<c.length;u++)a.setRequestHeader(c[u],V[e].sdkDomainHeader[c[u]]);a.onreadystatechange=function(){if(4===a.readyState){if(200===a.status){var t=P.isEmpty(a.response)?{}:JSON.parse(a.response);if(t&&200===t.status)return V[e].config=t.result.config,V[e].enterpriseDocumentToken=t.result.edmToken,V[e].requestTrace=t.result.traceId||"",r(!0);if(t.edmToken)return V[e].enterpriseDocumentToken=t.edmToken,V[e].requestTrace=t.traceId||"",r(!0);var n=(t=t||{}).status||500,o=t.message||g.message;return V[e].fail({status:n,message:o}),r(!1)}return V[e].fail({status:a.status,message:g.message}),r(!1)}},"GET"===V[e].tokenMethod?a.send():(a.setRequestHeader("Content-Type","application/json;charset=UTF-8"),a.send(JSON.stringify(P.setRequestEdmTokenQueryBody(i,s))))}))}},setVerify:function(e){V[e].verify=function(t){if(P.isEmpty(t))return V[e].fail(y),Promise.resolve(!1);for(var n=0;n<t.length;n++){var r=t[n];if(P.isEmpty(r.docVersion)&&(r.docVersion=""),1===t.length){var o=r.wmType;o&&"iwm"===o.toLowerCase()&&(r.wmType="all",r.iwmType=!0)}}return V[e].requestEdmToken(!0,t)}},setHandleProgress:function(e){V[e].handleProgress=V[e].progress,null!==V[e].handleProgress&&void 0!==V[e].handleProgress&&"function"==typeof V[e].handleProgress||(V[e].handleProgress=function(e){return e})},getBatchDownloadData:function(e,t){for(var n={type:"package",downloadTOs:[],attachdownloadTOs:[],transformType:"sync",isZip:"true"},r=0;r<e.length;r++)e[r].wmType?n.attachdownloadTOs.push(e[r]):n.downloadTOs.push(e[r]);return V[t].userId&&(n.userId=V[t].userId),n},getAsyncDownloadPackagesData:function(e,t){for(var n={type:"package",downloadTOs:[],attachdownloadTOs:[]},r=0;r<e.length;r++)e[r].wmType?n.attachdownloadTOs.push(e[r]):n.downloadTOs.push(e[r]);return V[t].pushAppMsg&&(n.pushAppMsg=V[t].pushAppMsg),V[t].wmType&&(n.wmType=V[t].wmType),V[t].userId&&(n.userId=V[t].userId),n},getBatchDownloadUrl:function(e,t){var n=V[e].edmServiceDomain+V[e].contextPath[t];if(V[e].userId){var r={};r.userId=V[e].userId,n=P.uriParamFormat(n,r)}return n},setBatchProgress:function(e,t,n){var r=!0,o=setInterval((function(){r=!0}),1e3);e.addEventListener("progress",(function(a){var i=e.getResponseHeader("Content-Size"),s=(a.loaded/i*100).toFixed(2);s>=100&&(s=90..toFixed(2));var c={total:i,loaded:a.loaded};!0===r&&(Q.CalculateNetworkSpeed(t,n,c),r=!1),a.loaded===a.total&&clearInterval(o),V[t].handleProgress(s)}),!1)},setCompDownload:function(e,t,n){var r=new Blob([e.response],{type:"appliction/zip"}),o=e.getResponseHeader("Content-Disposition"),a=Q.responseFileName(o,"UnKnow Name.zip"),i=window.URL||window.webkitURL||window.mozURL;if(Q.isIE&&void 0!==window.navigator.msSaveBlob)window.navigator.msSaveBlob(r,a);else{var s=i.createObjectURL(r),c=document.createElement("a");c.href=s,c.download=a,c.style.display="none",document.body.appendChild(c),c.click(),document.body.removeChild(c)}"Batch"===n&&V[t].handleProgress(100..toFixed(2))},setAsyncDownloadFail:function(e){V[e].asyncDownloadFail=function(t){var n="application/json;charset=UTF-8"!==t.getResponseHeader("Content-Type");if(4===t.readyState&&200===t.status&&!n&&null!==t.response){var r=new FileReader;return r.readAsText(t.response,"utf-8"),r.onload=function(t){V[e].fail(JSON.parse(t.target.result))},!1}return!0}},setAsyncDownloadLink:function(e){V[e].asyncDownloadLink=function(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;if(Q.asyncIndex++,!(Q.asyncIndex>=Q.asyncLinkLength)){var a=n[Q.asyncIndex].downloadLink;V[e].cacheDocuments[r].xhr=P.newXMLHttpRequest(V[e].withCredentials);var i=V[e].cacheDocuments[r].xhr;i.open("GET",a,!0),i.responseType="blob",Q.setBatchProgress(i,e,r),i.setRequestHeader(Q.HEADERS.TOKEN,V[e].enterpriseDocumentToken),i.setRequestHeader("x-csrf-token",V[e].xCsrfToken),Q.updateDocStatus(e,r,102,"Downloading;正在下载中"),i.onreadystatechange=function(){return V[e].asyncDownloadFail(i)?4===i.readyState&&200===i.status?(Q.updateDocStatus(e,r,200,"Download complete;下载完成"),Q.asyncCntSuccess++,Q.asyncCntSuccess===n.length&&Q.DownloadFinish(e),Q.clearNetworkSpeed(e),Q.resolveDownloadResponse(i.response,(function(){Q.setCompDownload(i,e,"Batch")}),(function(n){V[e].fail(n,t)})),V[e].asyncDownloadLink(t,n,r),!0):4===i.readyState&&0===i.status?!0===V[e].cacheDocuments[r].abort?(Q.updateDocStatus(e,r,0,"The download is canceled,下载被取消"),!0):(o<Q.REPLAY_LIMIT?(o++,V[e].asyncDownloadLink(t,n,r,o)):Q.clearNetworkSpeed(e),!1):4===i.readyState?(V[e].responseErrorResolve(t,i,(function(){V[e].asyncDownloadLink(t,r)})),V[e].asyncDownloadLink(t,n,r),Q.clearNetworkSpeed(e),!1):void 0:(V[e].asyncDownloadLink(t,n,r),!1)},i.send()}}},setAsyncDownloadPackages:function(e){V[e].asyncDownloadPackages=function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=Q.getAsyncDownloadPackagesData(t,e),a=Q.getBatchDownloadUrl(e,"asyncPackages");V[e].cacheDocuments[n].xhr=P.newXMLHttpRequest(V[e].withCredentials);var i=V[e].cacheDocuments[n].xhr;i.open("POST",a,!0),i.setRequestHeader(Q.HEADERS.CONTENT_TYPE,"application/json;charset=UTF-8"),i.setRequestHeader(Q.HEADERS.APP_ID,V[e].appId),i.setRequestHeader(Q.HEADERS.TRACE_ID,V[e].requestTrace+Date.now()),0===V[e].enterpriseDocumentToken.indexOf("Basic")?(i.setRequestHeader(Q.HEADERS.OLD_TOKEN,V[e].enterpriseDocumentToken),i.setRequestHeader("x-csrf-token",V[e].xCsrfToken),i.setRequestHeader(Q.HEADERS.API_ALIAS,Q.apiParams.apiAliasBatch)):(i.setRequestHeader(Q.HEADERS.TOKEN,V[e].enterpriseDocumentToken),i.setRequestHeader("x-csrf-token",V[e].xCsrfToken)),i.onreadystatechange=function(){if(4===i.readyState&&200===i.status){if(200!==JSON.parse(i.response).status){var o={status:JSON.parse(i.response).status,message:JSON.parse(i.response).message};V[e].fail(o,t)}else{var a=JSON.parse(i.response).result;Q.asyncLinkLength=a.length,V[e].asyncDownloadLink(t,a,n)}return!0}return 4===i.readyState&&0===i.status?!0===V[e].cacheDocuments[n].abort?(Q.updateDocStatus(e,n,0,"The download is canceled,下载被取消"),!0):(r<Q.REPLAY_LIMIT?(r++,V[e].asyncDownloadPackages(t,NetId,r)):Q.clearNetworkSpeed(e),!1):4===i.readyState?(V[e].responseErrorResolve(t,i,(function(){V[e].asyncDownloadPackages(t,NetId)})),Q.clearNetworkSpeed(e),!1):void 0},i.send(JSON.stringify(o))}},setBatchDownload:function(e){V[e].batchDownload=function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=Q.getBatchDownloadData(t,e),a=Q.getBatchDownloadUrl(e,"zip");V[e].cacheDocuments[n].xhr=P.newXMLHttpRequest(V[e].withCredentials);var i=V[e].cacheDocuments[n].xhr;i.open("POST",a,!0),i.responseType="blob",Q.setBatchProgress(i,e,n),i.setRequestHeader(Q.HEADERS.CONTENT_TYPE,"application/json;charset=UTF-8"),i.setRequestHeader(Q.HEADERS.APP_ID,V[e].appId),i.setRequestHeader(Q.HEADERS.TRACE_ID,V[e].requestTrace+Date.now()),0===V[e].enterpriseDocumentToken.indexOf("Basic")?(i.setRequestHeader(Q.HEADERS.OLD_TOKEN,V[e].enterpriseDocumentToken),i.setRequestHeader("x-csrf-token",V[e].xCsrfToken),i.setRequestHeader(Q.HEADERS.API_ALIAS,Q.apiParams.apiAliasBatch)):(i.setRequestHeader(Q.HEADERS.TOKEN,V[e].enterpriseDocumentToken),i.setRequestHeader("x-csrf-token",V[e].xCsrfToken)),Q.updateDocStatus(e,n,102,"Downloading;正在下载中"),i.onreadystatechange=function(){return 4===i.readyState&&200===i.status?(Q.updateDocStatus(e,n,200,"Download complete;下载完成"),V[e].cacheDocuments[n].ResponseHeader||(V[e].cacheDocuments[n].ResponseHeader={}),V[e].cacheDocuments[n].ResponseHeader.checkCode=i.getResponseHeader("checkCode"),V[e].cacheDocuments[n].ResponseHeader.ContentSize=i.getResponseHeader("Content-Size"),Q.DownloadFinish(e),Q.clearNetworkSpeed(e),Q.resolveDownloadResponse(i.response,(function(){Q.setCompDownload(i,e,"Batch")}),(function(n){V[e].fail(n,t)})),!0):4===i.readyState&&0===i.status?!0===V[e].cacheDocuments[n].abort?void Q.updateDocStatus(e,n,0,"The download is canceled,下载被取消"):(r<Q.REPLAY_LIMIT?(r++,V[e].batchDownload(t,n,r)):Q.clearNetworkSpeed(e),!1):4===i.readyState?(V[e].responseErrorResolve(t,i,(function(){V[e].batchDownload(t,n)})),Q.clearNetworkSpeed(e),!1):void 0},i.send(JSON.stringify(o))}},setClientPackDownload:function(e){V[e].clientPackDownload=K},getSingleDownloadPre:function(e,t){var n=V[e].edmServiceDomain+V[e].contextPath.single;return n=(n=(n=(n=n.replace("{docId}",t.docId)).replace("{docVersion}",t.docVersion)).replace("{wmType}",t.wmType||"")).replace("{decryptKey}",t.decryptKey||"")},getSingleDownloadUrl:function(e,t,n){var r=e+"&_t="+(new Date).getTime();if(V[n].userId){var o={};o.userId=V[n].userId,r=P.uriParamFormat(r,o)}return r},setSingleDownloadListener:function(e,t,n){var r=!0,o=setInterval((function(){r=!0}),1e3);e.addEventListener("progress",(function(a){var i=e.getResponseHeader("Content-Size"),s=(a.loaded/i*100).toFixed(2),c={total:i,loaded:a.loaded};!0===r&&(Q.CalculateNetworkSpeed(t,n,c),r=!1),a.loaded===a.total&&clearInterval(o),V[t].handleProgress(s)}),!1)},FirstNetworkSpeed:function(e,t){Q.Firstflag&&(Q.Firstflag=!1,Q.NetSpeedInterval=setInterval((function(){V[e].networkSpeed(Q.NetworkSpeedObject),Q.TemnetworkSpeed=0}),1e3))},CalculateNetworkSpeed:function(e,t,n){if(Q.NetworkSpeedObject[t]){var r=Q.NetworkSpeedObject[t].Nspeed;n.loaded-r>0&&(Q.NetworkSpeedObject[t].Nspeed=n.loaded-r),Q.NetworkSpeedObject[t].loaded=n.loaded}else Q.NetworkSpeedObject[t]={Nspeed:n.loaded,loaded:n.loaded,total:n.total};Q.getTemnetworkSpeed(e,Q.NetworkSpeedObject,t),Q.FirstNetworkSpeed(e,t)},getTemnetworkSpeed:function(e,t,n){var r=Q.NetworkSpeedObject[n].Nspeed;Q.TemnetworkSpeed+=r,Q.NetworkSpeedObject[n].NetworkSpeed=Q.TemnetworkSpeed},DownloadFinish:function(e){V[e].finish&&V[e].finish(V[e].cacheDocuments)},clearNetworkSpeed:function(e){clearInterval(Q.NetSpeedInterval),Q.Firstflag=!0},setQueryingDoc:function(e){V[e].QueryingDoc=function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=V[e].edmServiceDomain+V[e].contextPath.querying,a={docInfoVO:{ids:[t[0].docId],docType:t[0].wmType||"",docVersion:t[0].docVersion||""}},i=P.newXMLHttpRequest(V[e].withCredentials);i.open("POST",o,!0),i.setRequestHeader("Content-Type","application/json"),i.setRequestHeader(Q.HEADERS.APP_ID,V[e].appId),i.setRequestHeader(Q.HEADERS.TRACE_ID,V[e].requestTrace+Date.now()),0===V[e].enterpriseDocumentToken.indexOf("Basic")?(i.setRequestHeader(Q.HEADERS.OLD_TOKEN,V[e].enterpriseDocumentToken),i.setRequestHeader(Q.HEADERS.API_ALIAS,Q.apiParams.apiAliasSingle),i.setRequestHeader("x-csrf-token",V[e].xCsrfToken)):(i.setRequestHeader(Q.HEADERS.TOKEN,V[e].enterpriseDocumentToken),i.setRequestHeader("x-csrf-token",V[e].xCsrfToken)),i.onreadystatechange=function(o){if(4===i.readyState)return 200===i.status?(Q.SetDownMode(i,e,t,n),!0):0===i.status?r<Q.REPLAY_LIMIT?(r++,V[e].QueryingDoc(t,n,r),!1):(V[e].fail(b,t),!1):(V[e].responseErrorResolve(t,i,(function(){V[e].QueryingDoc(t,n)})),!0)},i.send(JSON.stringify(a))}},checkIwmTypeDoc:function(e,t){var n,r=t.filter((function(t){return t.version===e[0].docVersion}))[0].docInfo,o=r.filter((function(e){return!!e.wmType&&"iwm"===e.wmType.toString().toLowerCase()})),a=r.filter((function(e){return!!e.wmType&&"wm"===e.wmType.toString().toLowerCase()}));return o[0]?n=o[0].wmType:a[0]&&(n=a[0].wmType),n},SetCheckIwmType:function(e,t){if(e[0].iwmType){var n=t.result.outDocQueryList[0].verInfo,r=Q.checkIwmTypeDoc(e,n);r?e[0].wmType=r:e=[]}},SetDownMode:function(e,t,n,r){V[t].downloadComplete=localStorage.getItem("downloadComplete")||"true",localStorage.setItem("downloadComplete","false");var o=P.isEmpty(e.response)?{}:JSON.parse(e.response);try{if(o.result&&o.result.outDocQueryList.length>0&&o.result.outDocQueryList[0].verInfo[0]){var a=1,i=o.result.outDocQueryList[0].verInfo[0].docInfo[0];i.wmType=i.docType;for(var s=0;s<o.result.outDocQueryList[0].verInfo.length;s++){var c=o.result.outDocQueryList[0].verInfo[s],u=1*c.version.substr(1,c.version.length-1);u>a&&(i=c.docInfo[0],a=u)}n[0].fileSize=i.fileSize,n[0].docName=i.docName,Q.SetCheckIwmType(n,o),Q.setChunkConfig(t,o.result.outDocQueryList[0]),V[t].chunkAtom&&i.fileSize>1024*Q.CHUNK_ATOM*1024&&i.fileSize>1024*Q.CHUNK_LIMIT*1024||!V[t].chunkAtom&&i.fileSize>1024*Q.CHUNK_LIMIT*1024?m.openDB("edmDB","edmDownload").then((function(e){V[t].db=e,Q.initConfiguration(t,r),V[t].BasedDownload(n[0],r,i)})):V[t].singleDownload(n,r)}else o.result&&o.result.outDocQueryList.length>0&&!o.result.outDocQueryList[0].verInfo[0]?V[t].fail(N,n):V[t].fail({status:o.status,message:o.message},n)}catch(e){window.edmError=e,V[t].fail(T,n)}},shardGroup:function(e,t,n,r,o,a,i,s,c){V[e].downloadedStream=t,V[e].downloadedStream.size&&(V[e].resumableDownload=!0);for(var u=0;u<i+1;u++){var l=o.docId+"_"+o.docVersion+"_"+o.wmType+"_"+u;V[e].downloadedStream.has(l)&&V[e].writerFile.set(u,V[e].downloadedStream.get(l).fileStream);var d={index:u,chunkNum:f=u+1,file:null,Progress:0,startRange:0===u?0:u*a,endRange:f*a-1,complete:!1};if(u!==i)c.push(d);else if(0!==s){var f;d={index:u,chunkNum:f=i+1,Progress:0,file:null,startRange:(f-1)*a,endRange:(f-1)*a+s,complete:!1};c.push(d)}}V[e].CHUNK_LIST=c,V[e].CHUNK_NUM=c.length,V[e].CHUNK_FILENAME=n.docName,V[e].cacheDocuments[r].xhrMaps={},V[e].QueuingDownload(c,n,e,r,o)},setBasedDownload:function(e){V[e].BasedDownload=function(t,n,r){var o=t.fileSize,a=Q.getChunkAtomSize(e),i=Math.floor(o/a),s=o-a*i,c=[];"false"===V[e].downloadComplete?m.cursorGetData(V[e].db,"edmDownload").then((function(o){Q.shardGroup(e,o,t,n,r,a,i,s,c)})):Q.shardGroup(e,new Map,t,n,r,a,i,s,c)}},setQueuingDownloadHeader:function(e,t){return e.setRequestHeader(Q.HEADERS.APP_ID,V[t].appId),e.setRequestHeader(Q.HEADERS.TRACE_ID,V[t].requestTrace+Date.now()),0===V[t].enterpriseDocumentToken.indexOf("Basic")?(e.setRequestHeader(Q.HEADERS.OLD_TOKEN,V[t].enterpriseDocumentToken),e.setRequestHeader("x-csrf-token",V[t].xCsrfToken),e.setRequestHeader(Q.HEADERS.API_ALIAS,Q.apiParams.apiAliasSingle)):(e.setRequestHeader(Q.HEADERS.TOKEN,V[t].enterpriseDocumentToken),e.setRequestHeader("x-csrf-token",V[t].xCsrfToken)),e},setWriterFile:function(e,t,n,r,o,a){V[t].writeFileRunning=!0;var i=[],s=e.fileSize>104857600&&h&&navigator.userAgent.indexOf("Chrome")>0&&"https:"===location.protocol||"plugin"===V[t].downloadType;"serviceWorker"in navigator||(s=!1),s&&(V[t].fileStream=h.createWriteStream(a,{size:e.fileSize}),V[t].writer=V[t].fileStream.getWriter());var c=0,u=function(){if(V[t].writerFile.get(c))if(s){var l=new FileReader;l.readAsArrayBuffer(V[t].writerFile.get(c)),l.onload=function(){V[t].writer.write(new Uint8Array(l.result)).then((function(){V[t].writerFile.delete(c);var n=Math.trunc((c+1)/V[t].CHUNK_NUM*100*100)/100;V[t].handleProgress(n),c+1===V[t].CHUNK_NUM?(V[t].MergeFiles(t,r,e),V[t].writer.close(),V[t].fileStream=null,V[t].writer=null,localStorage.removeItem("downloadComplete"),m.deleteAllDate(V[t].db,"edmDownload",o).then((function(){m.deleteDBAll("edmDownload")}))):(c++,u())}))},l.onerror=function(e){"NotReadableError"===e.currentTarget.error.name?V[t].fail(I):"error"===e.type&&V[t].fail(w),V[t].netExceptionFlag=!0,V[t].fileStream?V[t].fileStream.abort():V[t].fileStream=null,V[t].writer?V[t].writer.abort():V[t].writer=null,V[t].fileStream=null,V[t].writer=null,V[t].CHUNK_DONE=V[t].CHUNK_NUM}}else{if(i.push(V[t].writerFile.get(c)),V[t].handleProgress(Math.trunc((c+1)/V[t].CHUNK_NUM*100*100)/100),c+1===V[t].CHUNK_NUM){V[t].MergeFiles(t,r,e);var d="";d=a.indexOf(".")>-1?new Blob(i):new Blob(i,{type:V[t].contentType}),localStorage.removeItem("downloadComplete"),m.deleteAllDate(V[t].db,"edmDownload",o).then((function(){m.closeDB(V[t].db);var e=window.URL||window.webkitURL||window.mozURL,n=e.createObjectURL(d),r=document.createElement("a");r.href=n,r.download=a,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),e.revokeObjectURL(n)}))}else c++,u();V[t].writerFile.delete(c)}else n[c]&&setTimeout((function(){u()}),1e3)};u()},setQueuingDownloadFail:function(e){V[e].QueuingDownloadFail=function(e,t,n,r,o){if(4===e.readyState&&200===e.status&&!t&&null!==e.response){var a=new FileReader,i=e.response;return o&&(i=new Blob([i])),a.readAsText(i,"utf-8"),a.onload=function(e){var t=JSON.parse(e.target.result);V[n].FirstPiece&&(V[n].fail(t,r),V[n].FirstPiece=!1)},!1}return!0}},responseResolve:function(e,t,n,r){if(4!==t.readyState||401!==t.status&&403!==t.status){if(4===t.readyState&&0===t.status){if(V[e].cacheDocuments[n.NetID].abort)return!1;if(r<Q.REPLAY_LIMIT)r++,n.recursion(n.params.index,r);else{if(V[e].failed)return;V[e].failed=!0,V[e].cacheDocuments[n.NetID].networkSpeed=0,clearInterval(V[e].NetSpeedInterval),P.getOnLine()?V[e].fail(I,n.doc):V[e].fail(b,n.doc),V[e].netExceptionFlag=!0,V[e].fileStream?V[e].fileStream.abort():V[e].fileStream=null,V[e].writer?V[e].writer.abort():V[e].writer=null,V[e].fileStream=null,V[e].writer=null}return!1}}else V[e].responseErrorResolve([n.doc],t,(function(){setTimeout((function(){n.recursion(n.params.index)}),100)}))},setQueuingDownloadXhh:function(e){V[e].QueuingDownloadXhh=function(e,t,n,r,o){var a="application/json;charset=UTF-8"!==e.getResponseHeader("Content-Type");if(!V[n].QueuingDownloadFail(e,a,n,t.doc,t.flag))return!1;if(4===e.readyState&&200===e.status&&a){if(0===t.params.index||V[n].resumableDownload){var i=Q.responseFileName(e.getResponseHeader("content-disposition"),"UnKnow Name.zip");V[n].contentType=e.getResponseHeader("Content-Type"),V[n].resumableDownload=!1,Q.setWriterFile(t.doc,n,t.list,t.NetID,r,i)}V[n].recursionNum++,V[n].CHUNK_DONE++;var s=e.response;s instanceof Blob||(s=new Blob([s])),V[n].writerFile.set(t.params.index,s);var c="".concat(r.docId,"_").concat(r.docVersion,"_").concat(r.wmType,"_").concat(t.params.index);return m.addData(V[n].db,"edmDownload",{key:c,fileStream:s,saveTime:(new Date).valueOf()}),V[n].CHUNK_DONE===V[n].CHUNK_NUM?(V[n].cacheDocuments[t.NetID].ResponseHeader={checkCode:e.getResponseHeader("checkCode"),ContentSize:t.doc.fileSize},V[n].cacheDocuments[t.NetID].networkSpeed=0,Q.clearNetworkSpeed(n)):V[n].CHUNK_DONE<V[n].CHUNK_NUM&&V[n].recursionNum-4<t.list.length&&t.recursion(V[n].recursionNum),delete V[n].cacheDocuments[t.NetID].xhrMaps[t.params.chunkNum],!0}Q.responseResolve(n,e,t,o)}},setQueuingDownload:function(e){V[e].QueuingDownload=function(e,t,n,r,o){Q.stopDonwload(n,r);var a=t.fileSize>104857600&&h&&navigator.userAgent.indexOf("Chrome")>0&&"https:"===location.protocol||"plugin"===V[n].downloadType,i=Q.getSingleDownloadPre(n,t),s=Q.getSingleDownloadUrl(i,t,n);V[n].recursionNum=Q.getLength(e,n)-1,Q.updateDocStatus(n,r,106,"Block downloading;分块下载中");for(var c=function(i){var u=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,l=o.docId+"_"+o.docVersion+"_"+o.wmType+"_"+i;V[n].downloadedStream.has(l)?(V[n].recursionNum++,V[n].CHUNK_DONE++,V[n].CHUNK_DONE===V[n].CHUNK_NUM?V[n].writeFileRunning||m.deleteAllDate(V[n].db,"edmDownload",o).then((function(){V[n].QueryingDoc([t],r)})):V[n].CHUNK_DONE<V[n].CHUNK_NUM&&V[n].recursionNum-4<e.length&&c(V[n].recursionNum)):e[i]&&null===e[i].file&&function(i,s,u){V[n].cacheDocuments[r].xhrMaps[s.chunkNum]=P.newXMLHttpRequest(V[n].withCredentials);var l=V[n].cacheDocuments[r].xhrMaps[s.chunkNum];if(l.open("GET",i,!0),l.responseType=a?"arraybuffer":"blob",l=Q.setQueuingDownloadHeader(l,n),Q.blockSpeed(l,n,r),t.fileName&&"string"==typeof t.fileName){if(!V[n].checkPoint(t.fileName))return;l.setRequestHeader("fileName",encodeURIComponent(t.fileName)),t.docName=t.fileName}var d={params:s,doc:t,list:e,flag:a,NetID:r,recursion:c};if(l.onreadystatechange=function(e){V[n].QueuingDownloadXhh(l,d,n,o,u)},V[n].netExceptionFlag)return!1;l.send()}(P.uriParamFormat(s,e[i]),e[i],u)},u=0;u<Q.getLength(e,n);u++)c(u)}},blockSpeed:function(e,t,n){var r=!0,o=setInterval((function(){r=!0}),1e3);e.addEventListener("progress",(function(a){var i={total:e.getResponseHeader("Content-Size"),loaded:a.loaded};!0===r&&(Q.CalculateNetworkSpeed(t,n,i),r=!1),a.loaded===a.total&&clearInterval(o)}),!1)},getLength:function(e,t){var n=e.length,r=Q.getChunkGroupSize(t);return e.length>r&&(n=r),n},setMergeFiles:function(e){V[e].MergeFiles=function(e,t,n){Q.updateDocStatus(e,t,107,"In Merge Files;合并文件中"),Q.updateDocStatus(e,t,200,"Download succeeded.;下载完成"),Q.DownloadFinish(e)}},SetResolveDownloadResponse:function(e,t,n,r){Q.resolveDownloadResponse(n.response,(function(){1===r.length&&0===r[0].fileSize&&V[e].handleProgress(100),Q.updateDocStatus(e,t,200,"Download succeeded.;下载完成"),Q.DownloadFinish(e),Q.setCompDownload(n,e)}),(function(n){Q.updateDocStatus(e,t,100,"The file name cannot contain special characters \\/:*?\"<>|'.;文件名不能包含特殊符号\\/:*?\"<>|'"),V[e].fail(n,r)}),V[e],r)},setCheckPoint:function(e){V[e].checkPoint=function(t){return"."!==t[0]||(V[e].fail(E),!1)}},setSingleDownload:function(e){V[e].singleDownload=function(t,n){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=t[0],a=Q.getSingleDownloadPre(e,o),i=Q.getSingleDownloadUrl(a,o,e);V[e].cacheDocuments[n].xhr=P.newXMLHttpRequest(V[e].withCredentials);var s=V[e].cacheDocuments[n].xhr;if(Q.setSingleDownloadListener(V[e].cacheDocuments[n].xhr,e,n),s.open("GET",i,!0),s.responseType="blob",s.setRequestHeader(Q.HEADERS.APP_ID,V[e].appId),s.setRequestHeader(Q.HEADERS.TRACE_ID,V[e].requestTrace+Date.now()),0===V[e].enterpriseDocumentToken.indexOf("Basic")?(s.setRequestHeader(Q.HEADERS.OLD_TOKEN,V[e].enterpriseDocumentToken),s.setRequestHeader("x-csrf-token",V[e].xCsrfToken),s.setRequestHeader(Q.HEADERS.API_ALIAS,Q.apiParams.apiAliasSingle)):(s.setRequestHeader(Q.HEADERS.TOKEN,V[e].enterpriseDocumentToken),s.setRequestHeader("x-csrf-token",V[e].xCsrfToken)),o.fileName&&"string"==typeof o.fileName){if(!V[e].checkPoint(o.fileName))return;s.setRequestHeader("fileName",encodeURIComponent(o.fileName))}Q.updateDocStatus(e,n,102,"Downloading;正在下载中"),s.onreadystatechange=function(o){if(200===s.status&&4===s.readyState)return V[e].cacheDocuments[n].ResponseHeader||(V[e].cacheDocuments[n].ResponseHeader={}),V[e].cacheDocuments[n].ResponseHeader.checkCode=s.getResponseHeader("checkCode"),V[e].cacheDocuments[n].ResponseHeader.ContentSize=s.getResponseHeader("Content-Size"),Q.SetResolveDownloadResponse(e,n,s,t),V[e].cacheDocuments[n].networkSpeed=0,Q.clearNetworkSpeed(e),!0;if(0===s.status&&4===s.readyState){if(!0===V[e].cacheDocuments[n].abort)return Q.updateDocStatus(e,n,0,"The download is canceled,下载被取消"),Q.clearNetworkSpeed(e),!0;if(!(r<Q.REPLAY_LIMIT))return V[e].cacheDocuments[n].networkSpeed=0,clearInterval(V[e].NetSpeedInterval),V[e].fail(I,t),!1;r++,V[e].singleDownload(t,n,r)}else if(4===s.readyState)return V[e].responseErrorResolve(t,s,(function(){V[e].singleDownload(t,n)})),!1},s.send()}},defaultNetwork:function(e){V[e].network=V[e].network||"internal"},resolveDownloadResponse:function(e,t,n,r,o){if("application/json"===e.type){var a=new FileReader;a.readAsText(e,"utf-8"),a.onload=function(e){var t=a.result,i=JSON.parse(t);if(302===i.status&&r&&null!==i.result){var s=function(e,t){var n=e.length-t.length;return e.substr(n,t.length)===t},c=i.result.siteDomain;s(c,"/edm/")||s(c,"/edm")||(c+="/edm"),r.edmServiceDomain=c,r.download(o)}else 12096===i.status?n(A):n(i)}}else t()},responseFileName:function(e,t){var n=t||"Unknown Name";if(!P.isEmpty(e)){var r=e.indexOf("fileName="),o="fileName=";-1===r&&(o="fileName*=UTF-8''",-1===(r=e.indexOf("fileName*=UTF-8''"))&&(o="filename*=UTF-8''",r=e.indexOf("filename*=UTF-8''"))),n=e.substring(r,e.length).replace(o,"")}return decodeURIComponent(n)},updateDocStatus:function(e,t,n,r){V[e].cacheDocuments[t].status={statusCode:n,message:r},V[e].downloadStatus(V[e].cacheDocuments)},getChunkAtom:function(e){e&&(Q.CHUNK_ATOM=e,Q.CHUNK_ATOM-2<0||4>Q.CHUNK_ATOM&&Q.CHUNK_ATOM>=2?Q.CHUNK_ATOM=2:8>Q.CHUNK_ATOM&&Q.CHUNK_ATOM>=4?Q.CHUNK_ATOM=4:16>Q.CHUNK_ATOM&&Q.CHUNK_ATOM>=8?Q.CHUNK_ATOM=8:32>Q.CHUNK_ATOM&&Q.CHUNK_ATOM>=16?Q.CHUNK_ATOM=16:64>Q.CHUNK_ATOM&&Q.CHUNK_ATOM>=32?Q.CHUNK_ATOM=32:Q.CHUNK_ATOM-64>0&&(Q.CHUNK_ATOM=64))},setChunkConfig:function(e,t){var n=t.downloadChunkSize,r=t.downloadChunkGroupSize;V[e].downloadChunkConfig={},P.isNumeric(n)&&(V[e].downloadChunkConfig.downloadChunkSize=n),P.isNumeric(r)&&(V[e].downloadChunkConfig.downloadChunkGroupSize=r)},getChunkAtomSize:function(e){var t=V[e].downloadChunkConfig||{};return Object.prototype.hasOwnProperty.call(t,"downloadChunkSize")?1024*t.downloadChunkSize*1024:1024*Q.CHUNK_ATOM*1024},getChunkGroupSize:function(e){var t=V[e].downloadChunkConfig||{};return Object.prototype.hasOwnProperty.call(t,"downloadChunkGroupSize")?t.downloadChunkGroupSize:Q.CHUNK_BATCH_LIMIT},initConfiguration:function(e){V[e].CHUNK_LIST=[],V[e].CHUNK_NUM=0,V[e].CHUNK_DONE=0,V[e].writerFile=new Map,V[e].CHUNK_FILENAME="UnKnowName.zip",V[e].PROGRESS=0,V[e].QUEUING=0,V[e].batchQUEUING=0,V[e].FirstPiece=!0,Q.errIndex=0,Q.RequestStatus="Requesting",Q.NetworkSpeedObject={},Q.asyncCntSuccess=0,Q.asyncIndex=-1,V[e].writeFileRunning=!1},checkEnableClientPack:function(e){return new Promise((function(t,n){if("http:"===location.protocol)return t(!1);if(void 0===Q.clientPackFlag){Q.clientPackFlag=!1;var r=Q.getBatchDownloadUrl(e,"clientPackSwitch"),o=P.newXMLHttpRequest(V[e].withCredentials);o.open("GET",r,!0),o.setRequestHeader(Q.HEADERS.APP_ID,V[e].appId),o.setRequestHeader(Q.HEADERS.TRACE_ID,V[e].requestTrace+Date.now()),0===V[e].enterpriseDocumentToken.indexOf("Basic")?(o.setRequestHeader(Q.HEADERS.OLD_TOKEN,V[e].enterpriseDocumentToken),o.setRequestHeader("x-csrf-token",V[e].xCsrfToken),o.setRequestHeader(Q.HEADERS.API_ALIAS,Q.apiParams.apiAliasSingle)):(o.setRequestHeader(Q.HEADERS.TOKEN,V[e].enterpriseDocumentToken),o.setRequestHeader("x-csrf-token",V[e].xCsrfToken)),o.onreadystatechange=function(){if(4===o.readyState)if(200===o.status)try{var e=JSON.parse(o.responseText);200===e.status&&(Q.clientPackFlag=e.result)}catch(e){}finally{t(Q.clientPackFlag)}else t(Q.clientPackFlag)},o.send()}else t(Q.clientPackFlag)}))}};window.EDMDownloadInstance=function(e){var t=function(e){var t=P.getRandomValue();if(V[t]=e,!Q.isEmptyOp(t)&&!Q.isEmptyAppId(t))return Q.defaultNetwork(t),Q.setFail(t),Q.setNetworkSpeed(t),Q.setServiceDomain(t),Q.setResponseErrorResolve(t),Q.setRequestEdmToken(t),Q.setVerify(t),Q.setHandleProgress(t),Q.setBatchDownload(t),Q.setClientPackDownload(t),Q.setSingleDownload(t),Q.setQueryingDoc(t),Q.setBasedDownload(t),Q.setQueuingDownload(t),Q.setMergeFiles(t),Q.setStatusCallback(t),Q.setCheckPoint(t),Q.clearNetworkSpeed(t),Q.setQueuingDownloadFail(t),Q.setQueuingDownloadXhh(t),Q.setAsyncDownloadPackages(t),Q.setAsyncDownloadLink(t),Q.setAsyncDownloadFail(t),V[t].cacheDocuments={},t}(e);V[t].generateToken=e.generateToken,window.addEventListener("beforeunload",(function(e){V[t].writer&&V[t].writer.abort(),V[t].fileStream&&V[t].fileStream.abort()})),this.download=function(e){var n=P.getRandomValue();Q.initConfiguration(t),V[t].verify(e).then((function(r){r&&(V[t].cacheDocuments[n]={docs:e},Q.updateDocStatus(t,n,101,"Ready to download;准备下载中"),1===e.length?V[t].QueryingDoc(e,n):!0===V[t].asyncPackages?V[t].asyncDownloadPackages(e,n):Q.checkEnableClientPack(t).then((function(r){r?V[t].clientPackDownload(e,V[t],Q,t,n):V[t].batchDownload(e,n)})))}))},this.abortDownload=function(e){if(V[t].cacheDocuments[e].abort=!0,Q.updateDocStatus(t,e,0,"The download is canceled,下载被取消"),1===V[t].cacheDocuments[e].docs.length)if(V[t].cacheDocuments[e].xhrMaps){for(var n in V[t].cacheDocuments[e].xhrMaps){if(Object.hasOwnProperty.call(V[t].cacheDocuments[e].xhrMaps,n))V[t].cacheDocuments[e].xhrMaps[n].abort()}V[t].cacheDocuments[e].xhrMaps=null,V[t].writer&&(V[t].writer.abort(),V[t].writer=null)}else V[t].cacheDocuments[e].xhr.abort();else V[t].cacheDocuments[e].xhr.abort()}}}();
